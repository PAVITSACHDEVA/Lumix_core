<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Squeeze Pro | Ultimate Batch Suite</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        :root { --radius: 20px; --accent: #7873f5; --danger: #ff4757; }
        * { box-sizing: border-box; }
        
        body {
            margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(270deg, #1a1a2e, #16213e, #0f3460);
            font-family: 'Poppins', sans-serif; color: #fff; overflow-x: hidden;
        }

        /* Nav */
        nav {
            width: 100%; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .nav-logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: #fff; }
        .nav-links { display: flex; gap: 10px; list-style: none; margin: 0; padding: 0; }
        .nav-link { 
            text-decoration: none; color: #fff; font-size: 0.8rem; font-weight: 600; 
            opacity: 0.7; transition: 0.3s; cursor: pointer; padding: 8px 12px; border-radius: 8px;
        }
        .nav-link:hover, .nav-link.active { opacity: 1; background: rgba(255,255,255,0.15); }

        .container {
            text-align: center; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
            padding: 30px; border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            width: min(1100px, 95vw); margin: 30px 0; border: 1px solid rgba(255,255,255,0.1);
        }

        .app-view { display: none; animation: fadeIn 0.4s ease; }
        .app-view.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        /* Upload area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 40px 20px;
            background: rgba(255, 255, 255, 0.02); cursor: pointer; transition: 0.3s; margin-bottom: 20px;
        }
        .upload-area:hover { border-color: var(--accent); background: rgba(120, 115, 245, 0.05); }

        /* Batch List & Sorting */
        .batch-list {
            display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;
            max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px;
        }
        .file-item {
            background: rgba(255, 255, 255, 0.08); padding: 12px 18px; border-radius: 10px;
            display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem; transition: 0.2s;
        }
        .file-item.sortable-ghost { opacity: 0.4; background: var(--accent); }
        .drag-handle { cursor: grab; margin-right: 15px; opacity: 0.5; font-size: 1.2rem; }

        /* Settings */
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px; text-align: left; margin-bottom: 20px;
        }
        .card { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .card h3 { font-size: 0.8rem; margin: 0 0 15px 0; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }

        input, select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2); color: #fff; outline: none; margin-bottom: 10px;
        }

        .action-btn {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            background: var(--accent); color: #fff; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.3s;
        }
        .action-btn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-2px); }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Visual Deleter Modal */
        #deleter-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000; display: none; padding: 40px;
            overflow-y: auto;
        }
        .thumb-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .thumb-item {
            position: relative; background: #fff; padding: 5px; border-radius: 5px; cursor: pointer;
            transition: 0.3s; border: 3px solid transparent;
        }
        .thumb-item.deleted { opacity: 0.3; border-color: var(--danger); }
        .thumb-item.deleted::after {
            content: "REMOVE"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--danger); color: #fff; padding: 4px 8px; font-size: 10px; font-weight: 800; border-radius: 4px;
        }
        .thumb-item canvas { width: 100%; height: auto; display: block; }

        /* Results Display */
        .results-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; margin-top: 20px; }
        .res-card { 
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; 
            text-align: left; border: 1px solid rgba(255,255,255,0.1); position: relative;
        }
        .size-tag {
            display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.75rem;
        }
        .saving-badge { background: #4ade80; color: #000; padding: 2px 8px; border-radius: 50px; font-weight: 800; }

        /* Drawer and Toast */
        #drawer {
            position: fixed; right: -320px; top: 80px; width: 300px; height: calc(100vh - 100px);
            background: rgba(10, 10, 30, 0.95); backdrop-filter: blur(20px); transition: 0.4s;
            z-index: 2000; padding: 20px; border-radius: 20px 0 0 20px; border-left: 1px solid rgba(255,255,255,0.1);
        }
        #drawer.open { right: 0; }
        .drawer-toggle {
            position: absolute; left: -50px; top: 20px; width: 50px; height: 50px;
            background: rgba(255,255,255,0.1); border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 30px; border-radius: 50px; background: #333; color: #fff; z-index: 9999; opacity: 0; transition: 0.3s;
        }
        .checkbox-group {
            display: flex; flex-direction: column; gap: 8px; font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="drawer">
        <div class="drawer-toggle" onclick="toggleDrawer()">ðŸ•’</div>
        <h3 style="margin-top:0">Session History</h3>
        <div id="historyList"></div>
    </div>

    <!-- Visual Deleter UI -->
    <div id="deleter-modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Page Remover & Preview</h2>
            <button onclick="closeDeleter()" class="action-btn" style="width:auto; padding:10px 30px; background:var(--danger)">Done</button>
        </div>
        <p>Click pages you want to remove from the document.</p>
        <div id="thumbGrid" class="thumb-grid"></div>
    </div>

    <nav>
        <a href="#" class="nav-logo">PDF SQUEEZE PRO</a>
        <ul class="nav-links">
            <li><a class="nav-link active" data-view="compress" onclick="showView('compress')">Optimize</a></li>
            <li><a class="nav-link" data-view="merge" onclick="showView('merge')">Merge</a></li>
            <li><a class="nav-link" data-view="watermark" onclick="showView('watermark')">Brand</a></li>
            <li><a class="nav-link" data-view="convert" onclick="showView('convert')">Export</a></li>
        </ul>
    </nav>

    <div class="container">
        
        <!-- OPTIMIZE VIEW -->
        <div id="view-compress" class="app-view active-view">
            <h1>Advanced Optimizer</h1>
            <div class="upload-area" onclick="triggerUpload('compress')" ondragover="e=>e.preventDefault()" ondrop="handleDrop(event, 'compress')">
                <span id="label-compress">Drop PDFs to Optimize</span>
                <input type="file" id="input-compress" multiple hidden accept=".pdf" onchange="handleFiles('compress')">
            </div>
            <div id="list-compress" class="batch-list"></div>
            
            <div class="settings-grid">
                <div class="card">
                    <h3>Renaming</h3>
                    <input type="text" id="ren-prefix" placeholder="Prefix (e.g. Final_)">
                    <input type="text" id="ren-suffix" placeholder="Suffix (e.g. _v1)">
                    <button class="action-btn" id="btn-preview-delete" style="padding:10px; font-size:0.8rem; background:rgba(255,255,255,0.1)" disabled onclick="openDeleter()">PREVIEW & DELETE PAGES</button>
                </div>
                <div class="card">
                    <h3>Optimization Options</h3>
                    <select id="opt-level">
                        <option value="max">Extreme Squeeze (Low DPI)</option>
                        <option value="med" selected>Medium (Standard 150 DPI)</option>
                        <option value="min">Light (High 300 DPI)</option>
                        <option value="lossless">Lossless (No image re-encoding)</option>
                    </select>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="mode-grayscale"> Force Grayscale</label>
                        <label><input type="checkbox" id="mode-strip-metadata" checked> Strip Metadata (Author, Title, etc.)</label>
                    </div>
                </div>
            </div>
            <button class="action-btn" id="btn-compress" disabled onclick="processBatch('compress')">SQUEEZE BATCH</button>
            <div id="results-compress" class="results-container"></div>
        </div>

        <!-- MERGE VIEW -->
        <div id="view-merge" class="app-view">
            <h1>Merge & Reorder</h1>
            <p>Drag the file bars to change the sequence of the merged document.</p>
            <div class="upload-area" onclick="triggerUpload('merge')">
                <span>Drop PDFs to Bind Together</span>
                <input type="file" id="input-merge" multiple hidden accept=".pdf" onchange="handleFiles('merge')">
            </div>
            <div id="list-merge" class="batch-list"></div>
            <div class="settings-grid">
                <div class="card">
                    <h3>Filename</h3>
                    <input type="text" id="merge-name" placeholder="Final Filename" value="merged_output">
                </div>
                <div class="card">
                    <h3>Pages</h3>
                    <label style="font-size:0.75rem"><input type="checkbox" id="mode-pagenum"> Add "Page X of Y" Footer</label>
                </div>
            </div>
            <button class="action-btn" id="btn-merge" disabled onclick="processBatch('merge')">REORDER & MERGE</button>
            <div id="results-merge" class="results-container"></div>
        </div>

        <!-- BRANDING VIEW -->
        <div id="view-watermark" class="app-view">
            <h1>Branding & Security</h1>
            <div class="upload-area" onclick="triggerUpload('watermark')">
                <span>Select PDFs to Watermark</span>
                <input type="file" id="input-watermark" multiple hidden accept=".pdf" onchange="handleFiles('watermark')">
            </div>
            <div id="list-watermark" class="batch-list"></div>
            
            <div class="settings-grid">
                <div class="card">
                    <h3>Text Content</h3>
                    <input type="text" id="wm-text" value="CONFIDENTIAL" placeholder="Watermark Text">
                    <input type="color" id="wm-color" value="#ff0000" style="height:40px">
                </div>
                <div class="card">
                    <h3>Appearance</h3>
                    <select id="wm-pos">
                        <option value="center">Center</option>
                        <option value="bottom-right">Bottom Right</option>
                        <option value="top-left">Top Left</option>
                    </select>
                    <input type="number" id="wm-opacity" value="0.3" step="0.1" min="0" max="1" placeholder="Opacity (0-1)">
                </div>
            </div>
            <button class="action-btn" id="btn-watermark" disabled onclick="processBatch('watermark')">APPLY BRANDING</button>
            <div id="results-watermark" class="results-container"></div>
        </div>

        <!-- EXPORT VIEW -->
        <div id="view-convert" class="app-view">
            <h1>PDF Export (Images)</h1>
            <div class="upload-area" onclick="triggerUpload('convert')">
                <span>Select PDFs to Convert</span>
                <input type="file" id="input-convert" multiple hidden accept=".pdf" onchange="handleFiles('convert')">
            </div>
            <div id="list-convert" class="batch-list"></div>
            
            <div class="settings-grid">
                <div class="card">
                    <h3>Format</h3>
                    <select id="conv-format">
                        <option value="image/png">PNG</option>
                        <option value="image/jpeg">JPEG</option>
                    </select>
                </div>
                <div class="card">
                    <h3>Quality</h3>
                    <input type="range" id="conv-quality" min="1" max="3" step="0.5" value="2">
                    <div style="font-size:0.7rem; display:flex; justify-content:space-between"><span>Low Res</span><span>High Res</span></div>
                </div>
            </div>
            <button class="action-btn" id="btn-convert" disabled onclick="processBatch('convert')">EXPORT IMAGES</button>
            <div id="results-convert" class="results-container"></div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let state = {
            files: [],
            pagesToDelete: new Set(),
            sortable: null
        };

        function showView(v) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active-view'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active-view');
            document.querySelector(`[data-view="${v}"]`).classList.add('active');
            state.files = [];
            updateUI(v);
        }

        function triggerUpload(v) { document.getElementById(`input-${v}`).click(); }

        function handleFiles(v) {
            const input = document.getElementById(`input-${v}`);
            state.files = [...state.files, ...Array.from(input.files)];
            updateUI(v);
        }

        function updateUI(v) {
            const list = document.getElementById(`list-${v}`);
            list.innerHTML = '';
            state.files.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.dataset.id = i;
                div.innerHTML = `
                    <div style="display:flex; align-items:center">
                        ${v === 'merge' ? '<span class="drag-handle">â˜°</span>' : ''}
                        <span>${f.name}</span>
                    </div>
                    <span onclick="removeFile(${i}, '${v}')" style="cursor:pointer; opacity:0.5">âœ•</span>
                `;
                list.appendChild(div);
            });

            document.getElementById(`btn-${v}`).disabled = state.files.length === 0;
            if (v === 'compress') document.getElementById('btn-preview-delete').disabled = state.files.length !== 1;

            if (v === 'merge' && state.files.length > 0) {
                if (state.sortable) state.sortable.destroy();
                state.sortable = new Sortable(list, {
                    handle: '.drag-handle', animation: 200, ghostClass: 'sortable-ghost',
                    onEnd: () => {
                        const newOrder = [];
                        list.querySelectorAll('.file-item').forEach(el => newOrder.push(state.files[el.dataset.id]));
                        state.files = newOrder;
                    }
                });
            }
        }

        function removeFile(i, v) { state.files.splice(i, 1); updateUI(v); }

        async function openDeleter() {
            const file = state.files[0];
            const modal = document.getElementById('deleter-modal');
            const grid = document.getElementById('thumbGrid');
            grid.innerHTML = 'Loading previews...';
            modal.style.display = 'block';
            state.pagesToDelete.clear();

            const data = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data}).promise;
            grid.innerHTML = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({scale: 0.3});
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({canvasContext: ctx, viewport}).promise;

                const div = document.createElement('div');
                div.className = 'thumb-item';
                div.appendChild(canvas);
                div.onclick = () => {
                    div.classList.toggle('deleted');
                    if (state.pagesToDelete.has(i-1)) state.pagesToDelete.delete(i-1);
                    else state.pagesToDelete.add(i-1);
                };
                grid.appendChild(div);
            }
        }

        function closeDeleter() { document.getElementById('deleter-modal').style.display = 'none'; }

        async function processBatch(type) {
            const btn = document.getElementById(`btn-${type}`);
            btn.disabled = true;
            notify("Processing...");

            try {
                if (type === 'compress') {
                    const prefix = document.getElementById('ren-prefix').value;
                    const suffix = document.getElementById('ren-suffix').value;
                    const stripMetadata = document.getElementById('mode-strip-metadata').checked;
                    const optLevel = document.getElementById('opt-level').value;
                    
                    const file = state.files[0];
                    const doc = await PDFLib.PDFDocument.load(await file.arrayBuffer());
                    
                    // Metadata Stripping
                    if (stripMetadata) {
                        doc.setTitle('');
                        doc.setAuthor('');
                        doc.setSubject('');
                        doc.setKeywords([]);
                        doc.setProducer('');
                        doc.setCreator('');
                        doc.setCreationDate(new Date());
                        doc.setModificationDate(new Date());
                    }

                    // Page Deletion Logic
                    if (state.pagesToDelete.size > 0) {
                        const indices = Array.from(state.pagesToDelete).sort((a,b) => b-a);
                        indices.forEach(idx => doc.removePage(idx));
                    }

                    // For real compression, standard browsers/libraries have limits
                    // In this context, we perform 'Structural' optimization and object clearing
                    const bytes = await doc.save({ 
                        useObjectStreams: optLevel !== 'lossless',
                        addDefaultPage: false 
                    });
                    
                    const newName = `${prefix}${file.name.replace('.pdf','')}${suffix}.pdf`;
                    renderResult(newName, bytes, file.size, type);
                }
                else if (type === 'merge') {
                    const merged = await PDFLib.PDFDocument.create();
                    let totalSize = 0;
                    for (const f of state.files) {
                        totalSize += f.size;
                        const donor = await PDFLib.PDFDocument.load(await f.arrayBuffer());
                        const pages = await merged.copyPages(donor, donor.getPageIndices());
                        pages.forEach(p => merged.addPage(p));
                    }
                    const bytes = await merged.save();
                    renderResult(document.getElementById('merge-name').value + ".pdf", bytes, totalSize, type);
                }
                else if (type === 'watermark') {
                    const text = document.getElementById('wm-text').value;
                    const colorHex = document.getElementById('wm-color').value;
                    const opacity = parseFloat(document.getElementById('wm-opacity').value);
                    const pos = document.getElementById('wm-pos').value;

                    for (const f of state.files) {
                        const doc = await PDFLib.PDFDocument.load(await f.arrayBuffer());
                        const pages = doc.getPages();
                        const r = parseInt(colorHex.slice(1,3), 16) / 255;
                        const g = parseInt(colorHex.slice(3,5), 16) / 255;
                        const b = parseInt(colorHex.slice(5,7), 16) / 255;

                        pages.forEach(p => {
                            const { width, height } = p.getSize();
                            let x = 50, y = 50;
                            if (pos === 'center') { x = width/2 - 100; y = height/2; }
                            else if (pos === 'top-left') { x = 50; y = height - 50; }
                            else if (pos === 'bottom-right') { x = width - 200; y = 50; }

                            p.drawText(text, {
                                x, y, size: 50,
                                color: PDFLib.rgb(r, g, b),
                                opacity,
                                rotate: PDFLib.degrees(pos === 'center' ? 45 : 0)
                            });
                        });
                        const bytes = await doc.save();
                        renderResult("branded_" + f.name, bytes, f.size, type);
                    }
                }
                else if (type === 'convert') {
                    const format = document.getElementById('conv-format').value;
                    const scale = parseFloat(document.getElementById('conv-quality').value);

                    for (const f of state.files) {
                        const data = await f.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({data}).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale });
                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width; canvas.height = viewport.height;
                            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                            
                            canvas.toBlob((blob) => {
                                blob.arrayBuffer().then(buf => {
                                    renderResult(`${f.name.replace('.pdf', '')}_page${i}.${format.split('/')[1]}`, new Uint8Array(buf), f.size/pdf.numPages, type);
                                });
                            }, format);
                        }
                    }
                }
            } catch (e) {
                notify("Error processing file", true);
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }

        function renderResult(name, bytes, oldSize, type) {
            const isImg = name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg');
            const blob = new Blob([bytes], {type: isImg ? 'image/png' : 'application/pdf'});
            const url = URL.createObjectURL(blob);
            const container = document.getElementById(`results-${type}`);
            
            const oldKB = (oldSize / 1024).toFixed(1);
            const newKB = (bytes.length / 1024).toFixed(1);
            const saved = Math.round((1 - (bytes.length / oldSize)) * 100);

            const card = document.createElement('div');
            card.className = 'res-card';
            card.innerHTML = `
                <div style="font-weight:700; margin-bottom:10px">${name}</div>
                <div class="size-tag">
                    <span>${oldKB} KB â†’ <b>${newKB} KB</b></span>
                    <span class="saving-badge" style="background:${saved > 0 ? '#4ade80' : '#f87171'}">
                        ${saved > 0 ? 'Squeezed ' + saved : saved}% Change
                    </span>
                </div>
                <button class="action-btn" style="padding:10px; font-size:0.8rem" onclick="download('${url}', '${name}')">Download</button>
            `;
            container.prepend(card);
        }

        function download(url, name) {
            const a = document.createElement('a'); a.href = url; a.download = name; a.click();
        }

        function notify(m, e=false) {
            const t = document.getElementById('toast');
            t.textContent = m; t.style.background = e ? '#ff4757' : '#7873f5';
            t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2500);
        }

        function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }
    </script>
</body>
</html>